<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitFast Ultra - The Ultimate GitHub IDE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Stripe JS for visual authenticity -->
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Fira Code', 'monospace'],
                    },
                    colors: {
                        'sidebar': '#0f172a',
                        'editor': '#1e293b',
                        'accent': '#38bdf8',
                        'success': '#4ade80',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(30, 41, 59, 0.7);
        }

        body {
            background-color: #0f1115;
            color: #e2e8f0;
            overflow: hidden; /* App-like feel */
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Utilities */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
        }

        .code-area {
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.6;
            tab-size: 4;
            background: transparent;
            color: #e2e8f0;
            caret-color: #38bdf8;
        }
        
        /* Syntax highlighting-ish colors for plain text context */
        .token-keyword { color: #c678dd; }
        .token-string { color: #98c379; }

        /* Loader */
        .loader-ring {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
        .loader-ring:after {
            content: " ";
            display: block;
            width: 16px;
            height: 16px;
            margin: 2px;
            border-radius: 50%;
            border: 2px solid #fff;
            border-color: #fff transparent #fff transparent;
            animation: loader-ring 1.2s linear infinite;
        }
        @keyframes loader-ring {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }

        /* Preview Frame */
        #previewFrame {
            background: white;
            transition: opacity 0.2s;
        }
        
        /* Tab Active State */
        .tab-btn.active {
            background: rgba(56, 189, 248, 0.15);
            color: #38bdf8;
            border-bottom: 2px solid #38bdf8;
        }
        
        .pricing-card {
            transition: all 0.3s ease;
        }
        .pricing-card:hover {
            transform: translateY(-5px);
            border-color: #38bdf8;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-sm">

    <!-- TOP BAR -->
    <header class="h-14 border-b border-slate-800 bg-[#0b0d11] flex items-center justify-between px-4 shrink-0 z-20">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 group cursor-pointer">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-600 to-cyan-500 flex items-center justify-center shadow-lg shadow-blue-500/20 group-hover:scale-105 transition-transform">
                    <i class="fas fa-bolt text-white text-sm"></i>
                </div>
                <h1 class="font-bold text-lg tracking-tight text-slate-100">GitFast <span class="text-accent font-black text-xs uppercase tracking-widest ml-1 bg-accent/10 px-2 py-0.5 rounded-full">Ultra</span></h1>
            </div>
            
            <div class="h-6 w-px bg-slate-800 mx-2"></div>

            <!-- Repo Selector -->
            <div class="relative group">
                <div class="flex items-center gap-2 bg-slate-800/50 hover:bg-slate-800 border border-slate-700 hover:border-slate-600 rounded-md px-3 py-1.5 transition-all cursor-pointer w-64" onclick="toggleRepoDropdown()">
                    <i class="fas fa-box-archive text-slate-400 text-xs"></i>
                    <input type="text" id="repoNameInput" class="bg-transparent border-none outline-none text-xs w-full text-slate-200 placeholder-slate-500 font-mono" placeholder="username/repo-name" autocomplete="off" oninput="handleRepoInput(this.value)">
                    <i class="fas fa-chevron-down text-slate-500 text-[10px]"></i>
                </div>
                <!-- Dropdown -->
                <div id="repoDropdown" class="absolute top-full left-0 mt-2 w-80 bg-[#1e293b] border border-slate-700 rounded-lg shadow-2xl overflow-hidden hidden z-50">
                    <div class="p-2 border-b border-slate-700 bg-slate-900/50">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Your Repositories</p>
                    </div>
                    <div id="repoList" class="max-h-60 overflow-y-auto">
                        <!-- Items injected here -->
                        <div class="p-4 text-center text-slate-500 text-xs italic">Connect token to load repos</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- Credits Badge -->
            <div class="hidden md:flex items-center gap-1.5 px-3 py-1 bg-slate-800/50 rounded-full border border-slate-700/50">
                <i class="fas fa-coins text-yellow-500 text-[10px]"></i>
                <span id="creditCount" class="text-[10px] font-mono text-slate-300">10 Credits</span>
            </div>

            <!-- User Status (Clickable) -->
            <div id="userProfile" onclick="openSettings()" class="hidden items-center gap-3 px-3 py-1.5 rounded-full bg-slate-900 border border-slate-800 hover:border-slate-600 cursor-pointer transition-all">
                <img id="userAvatar" src="" class="w-5 h-5 rounded-full border border-slate-700">
                <span id="userName" class="font-medium text-slate-300 text-xs">User</span>
            </div>

            <!-- Token Input (Compact) -->
            <div id="tokenContainer" class="relative group">
                <input type="password" id="ghToken" oninput="saveToken(this.value)" class="bg-slate-900 border border-slate-700 focus:border-accent rounded-full py-1.5 pl-4 pr-10 text-xs outline-none w-32 focus:w-64 transition-all duration-300" placeholder="GitHub Token...">
                <i class="fas fa-key absolute right-3 top-1/2 -translate-y-1/2 text-slate-600 text-xs"></i>
            </div>
        </div>
    </header>

    <!-- MAIN WORKSPACE -->
    <main class="flex-grow flex overflow-hidden">
        
        <!-- SIDEBAR (Removed Templates) -->
        <aside class="w-16 bg-[#0b0d11] border-r border-slate-800 flex flex-col items-center py-4 gap-4 shrink-0 z-10">
            <button onclick="setTab('html')" class="nav-btn w-10 h-10 rounded-xl flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-800 transition-all active" title="index.html">
                <i class="fab fa-html5 text-xl text-orange-500"></i>
            </button>
            <button onclick="setTab('css')" class="nav-btn w-10 h-10 rounded-xl flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-800 transition-all" title="style.css">
                <i class="fab fa-css3-alt text-xl text-blue-500"></i>
            </button>
            <button onclick="setTab('js')" class="nav-btn w-10 h-10 rounded-xl flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-800 transition-all" title="script.js">
                <i class="fab fa-js text-xl text-yellow-400"></i>
            </button>
            <button onclick="setTab('readme')" class="nav-btn w-10 h-10 rounded-xl flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-800 transition-all" title="README.md">
                <i class="fab fa-markdown text-xl text-white"></i>
            </button>
            
            <div class="h-px w-8 bg-slate-800 my-2"></div>
            
            <div class="mt-auto flex flex-col gap-4">
                 <button onclick="togglePreview()" class="w-10 h-10 rounded-xl flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-800 transition-all" title="Toggle Preview">
                    <i class="fas fa-columns text-lg"></i>
                </button>
            </div>
        </aside>

        <!-- EDITOR AREA -->
        <section class="flex-grow flex flex-col relative bg-[#0f1115]">
            <!-- File Info Bar -->
            <div class="h-10 border-b border-slate-800 flex items-center justify-between px-4 bg-[#0f1115]">
                <div class="flex items-center gap-2">
                    <i id="fileIcon" class="fab fa-html5 text-orange-500"></i>
                    <span id="fileName" class="font-mono text-xs text-slate-300">index.html</span>
                </div>
                <div class="flex items-center gap-3">
                     <span id="statusMsg" class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Ready</span>
                </div>
            </div>

            <!-- Code Editor -->
            <div class="flex-grow relative group">
                <textarea id="mainEditor" spellcheck="false" class="code-area w-full h-full p-6 resize-none outline-none text-sm z-10 relative" oninput="handleInput()"></textarea>
                <!-- Loading overlay for fetching files -->
                <div id="fileLoader" class="absolute inset-0 bg-slate-900/50 z-20 hidden flex items-center justify-center">
                     <div class="loader-ring"></div>
                </div>
            </div>

            <!-- Bottom Actions -->
            <div class="h-16 border-t border-slate-800 bg-[#0b0d11] flex items-center justify-between px-6 shrink-0">
                <div class="flex items-center gap-3 w-1/2">
                     <div class="relative w-full">
                        <i class="fas fa-code-commit absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                        <input type="text" id="commitMsg" class="bg-slate-900/50 border border-slate-700 rounded-lg py-2 pl-9 pr-3 text-xs w-full outline-none focus:border-slate-500 text-slate-300" placeholder="Commit message (e.g., 'Update styling')">
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="deployBtn" onclick="deploy()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg text-xs font-bold uppercase tracking-wider flex items-center gap-2 transition-all shadow-lg shadow-blue-900/20 active:scale-95">
                        <i class="fas fa-rocket"></i> Deploy <span id="deployCost" class="opacity-70 text-[10px] ml-1">(-1)</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- PREVIEW AREA -->
        <section id="previewPanel" class="w-[45%] border-l border-slate-800 bg-white relative flex flex-col transition-all duration-300">
            <div class="h-10 bg-slate-100 border-b border-slate-200 flex items-center justify-between px-3">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-circle text-red-400 text-[6px]"></i> Live Preview
                </span>
                <div class="flex gap-2">
                    <button onclick="refreshPreview()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-sync-alt text-xs"></i></button>
                    <button onclick="window.open(document.getElementById('previewFrame').src)" class="text-slate-400 hover:text-slate-600"><i class="fas fa-external-link-alt text-xs"></i></button>
                    <button onclick="togglePreview()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xs"></i></button>
                </div>
            </div>
            <iframe id="previewFrame" class="flex-grow w-full h-full bg-white"></iframe>
            
            <!-- Deployment Success Overlay -->
            <div id="deployOverlay" class="absolute inset-0 bg-slate-900/95 backdrop-blur-md z-50 flex flex-col items-center justify-center text-center p-8 hidden animate-slide-in">
                <div class="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mb-6">
                    <i class="fas fa-check text-2xl text-green-500"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Deployment Started!</h2>
                
                <div class="mb-8 mt-4">
                    <div id="timerContainer" class="flex flex-col items-center p-6 bg-slate-800/50 rounded-2xl border border-slate-700">
                        <span class="text-5xl font-mono font-bold text-white mb-2" id="deployTimer">30</span>
                        <span class="text-[10px] text-accent uppercase tracking-widest font-bold">Seconds remaining</span>
                    </div>
                </div>

                <p id="propagationMessage" class="text-slate-400 text-sm mb-8 max-w-xs mx-auto">
                    Waiting for GitHub to propagate changes to avoid 404 errors.
                </p>

                <div class="flex gap-4">
                    <a id="liveLink" href="#" target="_blank" class="bg-green-500 hover:bg-green-400 text-black font-bold py-3 px-8 rounded-xl transition-all active:scale-95 text-xs uppercase tracking-widest flex items-center gap-2">
                        Visit Live Site
                    </a>
                    <button onclick="closeOverlay()" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-8 rounded-xl transition-all text-xs uppercase tracking-widest">
                        Keep Editing
                    </button>
                </div>
            </div>

             <!-- Deployment Loading Overlay -->
            <div id="loadingOverlay" class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center text-center p-8 hidden">
                <div class="loader-ring mb-4"></div>
                <h3 class="text-lg font-bold text-white">Deploying...</h3>
                <p id="loadingStep" class="text-slate-500 text-xs mt-2 font-mono">Checking Credits...</p>
                <div class="w-64 h-1 bg-slate-800 rounded-full mt-6 overflow-hidden">
                    <div id="progressBar" class="h-full bg-blue-500 w-0 transition-all duration-300"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- SETTINGS & PAYMENT MODAL -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4" onclick="if(event.target === this) closeSettings()">
        <div class="bg-[#1e293b] border border-slate-700 rounded-2xl w-full max-w-4xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-[#0f172a]">
                <div class="flex items-center gap-3">
                    <img id="settingsAvatar" class="w-10 h-10 rounded-full border border-slate-600">
                    <div>
                        <h2 id="settingsName" class="text-lg font-bold text-white">User Settings</h2>
                        <p class="text-xs text-slate-400">Manage your account and billing</p>
                    </div>
                </div>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-8 bg-[#0f1115]">
                
                <!-- Token Section -->
                <div class="mb-8">
                    <h3 class="text-sm font-bold text-white uppercase tracking-widest mb-4 border-l-2 border-accent pl-3">GitHub Connection</h3>
                    <div class="bg-[#1e293b] p-6 rounded-xl border border-slate-700">
                        <label class="block text-xs text-slate-400 mb-2">Personal Access Token</label>
                        <div class="flex gap-4">
                            <input type="password" id="settingsTokenInput" class="flex-grow bg-[#0f1115] border border-slate-700 rounded-lg px-4 py-3 text-sm text-white focus:border-accent outline-none" placeholder="ghp_xxxxxxxxxxxx">
                            <button onclick="updateTokenFromSettings()" class="bg-slate-700 hover:bg-slate-600 text-white px-6 rounded-lg text-xs font-bold uppercase tracking-wider">Update</button>
                        </div>
                        <p class="text-[10px] text-slate-500 mt-2">Token is stored locally in your browser. We do not sync it to any server.</p>
                    </div>
                </div>

                <!-- Pricing Section -->
                <div>
                    <h3 class="text-sm font-bold text-white uppercase tracking-widest mb-4 border-l-2 border-green-500 pl-3">Deploy Credits</h3>
                    <div class="flex items-center justify-between mb-6">
                        <p class="text-slate-400 text-sm">Purchase credits to deploy your projects instantly. Credits never expire.</p>
                        <div class="text-right">
                             <span class="text-xs text-slate-500">Current Balance</span>
                             <div class="text-2xl font-bold text-white" id="modalCreditDisplay">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Free Tier -->
                        <div class="pricing-card bg-[#1e293b] border border-slate-700 p-6 rounded-2xl flex flex-col relative opacity-60">
                            <div class="absolute top-0 right-0 bg-slate-700 text-white text-[10px] px-2 py-1 rounded-bl-lg rounded-tr-lg font-bold">USED</div>
                            <h4 class="text-lg font-bold text-white mb-2">Starter</h4>
                            <div class="text-3xl font-bold text-slate-400 mb-4">Free</div>
                            <ul class="text-xs text-slate-400 space-y-2 mb-6 flex-grow">
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> 10 Initial Deploys</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-green-500"></i> Basic Support</li>
                            </ul>
                            <button disabled class="w-full py-3 rounded-lg bg-slate-700 text-slate-400 text-xs font-bold uppercase cursor-not-allowed">Claimed</button>
                        </div>

                        <!-- Basic Tier -->
                        <div class="pricing-card bg-[#1e293b] border border-blue-500/30 p-6 rounded-2xl flex flex-col relative shadow-lg shadow-blue-500/10">
                            <h4 class="text-lg font-bold text-white mb-2">Developer</h4>
                            <div class="text-3xl font-bold text-white mb-4">Â£1.00</div>
                            <ul class="text-xs text-slate-300 space-y-2 mb-6 flex-grow">
                                <li class="flex items-center gap-2"><i class="fas fa-check text-accent"></i> <strong>100</strong> Deploys</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-accent"></i> Priority Queue</li>
                            </ul>
                            <button onclick="simulatePayment(100)" class="w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold uppercase transition-colors">
                                <i class="fab fa-stripe mr-1"></i> Pay with Card
                            </button>
                        </div>

                        <!-- Pro Tier -->
                        <div class="pricing-card bg-gradient-to-b from-[#1e293b] to-purple-900/20 border border-purple-500/30 p-6 rounded-2xl flex flex-col relative shadow-lg shadow-purple-500/10">
                            <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-purple-500 text-white text-[10px] px-3 py-1 rounded-full font-bold shadow-lg">BEST VALUE</div>
                            <h4 class="text-lg font-bold text-white mb-2">Agency</h4>
                            <div class="text-3xl font-bold text-white mb-4">$4.99</div>
                            <ul class="text-xs text-slate-300 space-y-2 mb-6 flex-grow">
                                <li class="flex items-center gap-2"><i class="fas fa-check text-purple-400"></i> <strong>1,000</strong> Deploys</li>
                                <li class="flex items-center gap-2"><i class="fas fa-check text-purple-400"></i> Instant Propagation</li>
                            </ul>
                            <button onclick="simulatePayment(1000)" class="w-full py-3 rounded-lg bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold uppercase transition-colors">
                                <i class="fab fa-stripe mr-1"></i> Pay with Card
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            files: {
                'html': '',
                'css': '',
                'js': '',
                'readme': ''
            },
            currentTab: 'html',
            token: localStorage.getItem('gitfast_token') || '',
            credits: parseInt(localStorage.getItem('gitfast_credits') || '10'),
            user: null,
            repos: [],
            currentRepo: '',
            previewActive: true
        };

        const fileMetadata = {
            'html': { name: 'index.html', icon: 'fa-html5', color: 'text-orange-500' },
            'css': { name: 'style.css', icon: 'fa-css3-alt', color: 'text-blue-500' },
            'js': { name: 'script.js', icon: 'fa-js', color: 'text-yellow-400' },
            'readme': { name: 'README.md', icon: 'fa-markdown', color: 'text-white' }
        };

        // --- INIT ---
        window.onload = async () => {
            if ("Notification" in window) Notification.requestPermission();
            updateCreditDisplay();

            if (state.token) {
                document.getElementById('ghToken').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'; // Masked
                document.getElementById('settingsTokenInput').value = state.token;
                await fetchUserData();
                fetchRepos();
            }
            setTab('html');
            refreshPreview();
        };

        function updateCreditDisplay() {
            document.getElementById('creditCount').innerText = `${state.credits} Credits`;
            document.getElementById('modalCreditDisplay').innerText = state.credits;
            localStorage.setItem('gitfast_credits', state.credits);
        }

        // --- AUTH & USER DATA ---
        async function fetchUserData() {
            try {
                const res = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': `token ${state.token}` }
                });
                if (res.ok) {
                    state.user = await res.json();
                    // Top Bar UI
                    document.getElementById('userAvatar').src = state.user.avatar_url;
                    document.getElementById('userName').innerText = state.user.login;
                    document.getElementById('userProfile').classList.remove('hidden');
                    document.getElementById('userProfile').classList.add('flex');
                    document.getElementById('tokenContainer').classList.add('hidden');
                    
                    // Settings Modal UI
                    document.getElementById('settingsAvatar').src = state.user.avatar_url;
                    document.getElementById('settingsName').innerText = state.user.name || state.user.login;
                }
            } catch (e) { console.error(e); }
        }

        async function fetchRepos() {
            try {
                const res = await fetch(`https://api.github.com/user/repos?sort=updated&per_page=100`, {
                    headers: { 'Authorization': `token ${state.token}` }
                });
                if (res.ok) {
                    state.repos = await res.json();
                    renderRepoList();
                }
            } catch (e) { console.error(e); }
        }

        function saveToken(val) {
            if (val.trim().startsWith('ghp_')) {
                state.token = val.trim();
                localStorage.setItem('gitfast_token', state.token);
                document.getElementById('settingsTokenInput').value = state.token;
                fetchUserData();
                fetchRepos();
            }
        }

        function updateTokenFromSettings() {
            const val = document.getElementById('settingsTokenInput').value.trim();
            if (val.startsWith('ghp_')) {
                saveToken(val);
                alert("Token Updated Successfully");
                closeSettings();
            } else {
                alert("Invalid Token format. Must start with ghp_");
            }
        }

        // --- REPO HANDLING & CONTENT LOADING ---
        function toggleRepoDropdown() {
            const dd = document.getElementById('repoDropdown');
            dd.classList.toggle('hidden');
        }

        function renderRepoList(filter = '') {
            const list = document.getElementById('repoList');
            const filtered = state.repos.filter(r => r.full_name.toLowerCase().includes(filter.toLowerCase()));
            
            if (filtered.length === 0 && !state.user) {
                list.innerHTML = '<div class="p-4 text-center text-slate-500 text-xs italic">Connect token to load repos</div>';
                return;
            }

            list.innerHTML = filtered.map(r => `
                <div onclick="selectRepo('${r.full_name}')" class="p-3 border-b border-slate-800 hover:bg-slate-800 cursor-pointer transition-colors flex items-center justify-between group">
                    <div>
                        <div class="font-bold text-slate-300 text-xs group-hover:text-white">${r.name}</div>
                        <div class="text-[10px] text-slate-500">${new Date(r.updated_at).toLocaleDateString()}</div>
                    </div>
                    ${r.has_pages ? '<i class="fas fa-globe text-green-500 text-xs" title="Pages Active"></i>' : ''}
                </div>
            `).join('');
        }

        function handleRepoInput(val) {
            state.currentRepo = val;
            renderRepoList(val);
            if (val.length > 0) document.getElementById('repoDropdown').classList.remove('hidden');
        }

        async function selectRepo(name) {
            state.currentRepo = name;
            document.getElementById('repoNameInput').value = name;
            document.getElementById('repoDropdown').classList.add('hidden');
            await loadRepoContent(name);
        }

        async function loadRepoContent(fullRepoName) {
            // Show Loader
            document.getElementById('fileLoader').classList.remove('hidden');
            
            const [owner, repo] = fullRepoName.includes('/') ? fullRepoName.split('/') : [state.user.login, fullRepoName];
            const filesToFetch = ['index.html', 'style.css', 'script.js', 'README.md'];
            
            // Parallel fetch
            await Promise.all(filesToFetch.map(async (fileName) => {
                let key = '';
                if(fileName === 'index.html') key = 'html';
                else if(fileName === 'style.css') key = 'css';
                else if(fileName === 'script.js') key = 'js';
                else if(fileName === 'README.md') key = 'readme';

                try {
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`, {
                        headers: { 'Authorization': `token ${state.token}` }
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        // Handle UTF-8 decoding correctly
                        const content = decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, ""))));
                        state.files[key] = content;
                    } else {
                        // File not found -> Empty default
                        state.files[key] = '';
                    }
                } catch (e) {
                    console.error(`Error loading ${fileName}`, e);
                    state.files[key] = '';
                }
            }));

            // Update UI
            document.getElementById('mainEditor').value = state.files[state.currentTab];
            refreshPreview();
            document.getElementById('fileLoader').classList.add('hidden');
        }

        // --- EDITOR LOGIC ---
        function setTab(type) {
            state.files[state.currentTab] = document.getElementById('mainEditor').value;
            state.currentTab = type;
            document.getElementById('mainEditor').value = state.files[type];
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active', 'text-white', 'bg-slate-800'));
            const activeBtn = document.querySelector(`button[onclick="setTab('${type}')"]`);
            if (activeBtn) activeBtn.classList.add('active', 'text-white', 'bg-slate-800');

            const meta = fileMetadata[type];
            document.getElementById('fileName').innerText = meta.name;
            document.getElementById('fileIcon').className = `fab ${meta.icon} ${meta.color}`;
        }

        function handleInput() {
            state.files[state.currentTab] = document.getElementById('mainEditor').value;
            if (state.previewActive) {
                clearTimeout(window.previewTimer);
                window.previewTimer = setTimeout(refreshPreview, 800);
            }
        }

        // --- PREVIEW LOGIC ---
        function togglePreview() {
            const panel = document.getElementById('previewPanel');
            state.previewActive = !state.previewActive;
            if (state.previewActive) {
                panel.classList.remove('hidden');
                refreshPreview();
            } else {
                panel.classList.add('hidden');
            }
        }

        function refreshPreview() {
            const frame = document.getElementById('previewFrame');
            const html = state.files['html'];
            const css = state.files['css'];
            const js = state.files['js'];

            const doc = frame.contentWindow.document;
            doc.open();
            doc.write(html);
            const style = doc.createElement('style');
            style.textContent = css;
            doc.head.appendChild(style);
            const script = doc.createElement('script');
            script.textContent = `try { ${js} } catch(e) { console.error(e); }`;
            doc.body.appendChild(script);
            doc.close();
        }

        // --- SETTINGS & PAYMENT LOGIC ---
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function simulatePayment(amount) {
            // In a real app, this would use Stripe.js to create a token/intent
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            setTimeout(() => {
                state.credits += amount;
                updateCreditDisplay();
                alert(`Payment Successful! Added ${amount} credits.`);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 1500);
        }

        // --- DEPLOYMENT LOGIC ---
        async function deploy() {
            if (!state.token || !state.currentRepo) {
                alert("Please enter a GitHub Token and Repository Name.");
                return;
            }

            // CHECK CREDITS
            if (state.credits <= 0) {
                alert("Insufficient Deploy Credits. Please check your settings to top up.");
                openSettings();
                return;
            }

            // Save current tab
            state.files[state.currentTab] = document.getElementById('mainEditor').value;

            const btn = document.getElementById('deployBtn');
            const loader = document.getElementById('loadingOverlay');
            const progressBar = document.getElementById('progressBar');
            const stepText = document.getElementById('loadingStep');
            
            btn.disabled = true;
            loader.classList.remove('hidden');
            
            try {
                // Deduct Credit (Simulated)
                state.credits--;
                updateCreditDisplay();

                // 1. Check/Create Repo
                stepText.innerText = "Checking Repository...";
                progressBar.style.width = "10%";
                
                const [owner, repoName] = state.currentRepo.includes('/') ? state.currentRepo.split('/') : [state.user.login, state.currentRepo];
                
                const check = await fetch(`https://api.github.com/repos/${owner}/${repoName}`, { headers: { 'Authorization': `token ${state.token}` } });
                
                if (check.status === 404) {
                    stepText.innerText = "Creating Repository...";
                    await fetch('https://api.github.com/user/repos', {
                        method: 'POST',
                        headers: { 'Authorization': `token ${state.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: repoName, auto_init: true, description: "Created with GitFast Ultra" })
                    });
                    await new Promise(r => setTimeout(r, 2000));
                }

                // 2. Upload Files
                const filesToUpload = [
                    { path: 'index.html', content: state.files['html'] },
                    { path: 'style.css', content: state.files['css'] },
                    { path: 'script.js', content: state.files['js'] },
                    { path: 'README.md', content: state.files['readme'] }
                ];

                const total = filesToUpload.length;
                let completed = 0;

                for (const file of filesToUpload) {
                    if(!file.content) { completed++; continue; } // Skip empty files if needed, or upload empty
                    
                    stepText.innerText = `Uploading ${file.path}...`;
                    progressBar.style.width = `${20 + ((completed / total) * 60)}%`;
                    
                    let sha = null;
                    const getRes = await fetch(`https://api.github.com/repos/${owner}/${repoName}/contents/${file.path}`, { 
                        headers: { 'Authorization': `token ${state.token}` } 
                    });
                    if (getRes.ok) sha = (await getRes.json()).sha;

                    await fetch(`https://api.github.com/repos/${owner}/${repoName}/contents/${file.path}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${state.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: document.getElementById('commitMsg').value || `Update ${file.path} via GitFast Ultra`,
                            content: btoa(unescape(encodeURIComponent(file.content))),
                            sha: sha
                        })
                    });
                    completed++;
                }

                // 3. Enable Pages
                stepText.innerText = "Enabling GitHub Pages...";
                progressBar.style.width = "90%";
                await fetch(`https://api.github.com/repos/${owner}/${repoName}/pages`, {
                    method: 'POST',
                    headers: { 'Authorization': `token ${state.token}`, 'Accept': 'application/vnd.github.v3+json' },
                    body: JSON.stringify({ source: { branch: 'main', path: '/' } })
                }).catch(e => console.log("Pages might already be active"));

                progressBar.style.width = "100%";
                stepText.innerText = "Done!";
                
                setTimeout(() => {
                    loader.classList.add('hidden');
                    const url = `https://${owner}.github.io/${repoName}/`;
                    
                    // --- TIMER LOGIC ---
                    const overlay = document.getElementById('deployOverlay');
                    const timerDisplay = document.getElementById('deployTimer');
                    const visitBtn = document.getElementById('liveLink');
                    const propMsg = document.getElementById('propagationMessage');

                    visitBtn.href = url;
                    visitBtn.classList.add('opacity-50', 'pointer-events-none', 'grayscale');
                    visitBtn.innerHTML = '<i class="fas fa-clock animate-spin"></i> Wait 30s...';
                    propMsg.innerText = "Waiting for GitHub to propagate changes to avoid 404 errors.";
                    overlay.classList.remove('hidden');

                    let timeLeft = 30;
                    timerDisplay.innerText = timeLeft;

                    if (window.deployInterval) clearInterval(window.deployInterval);

                    window.deployInterval = setInterval(() => {
                        timeLeft--;
                        timerDisplay.innerText = timeLeft;
                        visitBtn.innerHTML = `<i class="fas fa-clock animate-spin"></i> Wait ${timeLeft}s...`;

                        if (timeLeft <= 0) {
                            clearInterval(window.deployInterval);
                            visitBtn.classList.remove('opacity-50', 'pointer-events-none', 'grayscale');
                            visitBtn.innerHTML = '<i class="fas fa-external-link-alt"></i> Visit Live Site';
                            propMsg.innerText = "Propagation complete! Your site should be live now.";
                            
                            if (Notification.permission === "granted") {
                                new Notification("Deployment Ready ðŸš€", {
                                    body: `Your site ${repoName} is now live!`,
                                    icon: "https://github.githubassets.com/favicons/favicon.png"
                                });
                            }
                        }
                    }, 1000);

                }, 500);

            } catch (e) {
                alert("Error: " + e.message);
                loader.classList.add('hidden');
            } finally {
                btn.disabled = false;
            }
        }

        function closeOverlay() {
            document.getElementById('deployOverlay').classList.add('hidden');
            if (window.deployInterval) clearInterval(window.deployInterval);
        }

    </script>
</body>
</html>